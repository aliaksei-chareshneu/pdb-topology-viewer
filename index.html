<html>

  <head>
	<!-- Molstar CSS & JS -->
    <link crossorigin="anonymous"rel="stylesheet" type="text/css" href="https://www.ebi.ac.uk/pdbe/pdb-component-library/css/pdbe-molstar-1.1.0.css">
    <script type="text/javascript" src="https://www.ebi.ac.uk/pdbe/pdb-component-library/js/pdbe-molstar-plugin-1.1.0.js"></script>
	
    <!-- d3.js dependency script -->
    <script src="https://cdn.jsdelivr.net/npm/d3@5.9.2"></script>
    
    <!-- PDB Topology Viewer JS -->
    <script type="text/javascript" src="build/pdb-topology-viewer-plugin-2.0.0.js" defer></script>
	
	<!-- math.js -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/9.4.3/math.min.js" integrity="sha512-h6sl9arHHMneDTSQwIiJ6NUSx3/wGWKr9P25MQCnwmTsPMBHIscEtk/5k/zA+IOjvGQUuvn2003cRhX2BUpgqw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	
	<!-- OverProt CSS and scripts -->
	<!-- All links are copied from the overprot.ncbr.muni.cz pages -->
	<link crossorigin="anonymous" rel='stylesheet' type='text/css' href='https://overprot.ncbr.muni.cz/static/overprot-viewer/overprot-viewer.min.css'>
	<script type='text/javascript' src='https://overprot.ncbr.muni.cz/static/overprot-viewer/d3.v5.min.js'></script>
	<script type='text/javascript' src='https://overprot.ncbr.muni.cz/static/overprot-viewer/d3-selection-multi.v1.min.js'></script>
	<script type='text/javascript' src='https://overprot.ncbr.muni.cz/static/overprot-viewer/overprot-viewer.min.js'></script>
	
	
	<!-- Bootstrap selects CSS & JS, popper js is required -->
	<link crossorigin="anonymous" rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
        integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
	<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/4.2.2/jquery.form.min.js"
        integrity="sha384-FzT3vTVGXqf7wRfy8k4BiyzvbNfeYjK+frTVqZeNDFl8woCbF0CYG6g2fMEFFo/i"
        crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
        integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
        crossorigin="anonymous"></script>
		
	<link crossorigin="anonymous" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
	
	
	
    <style>
		.flex-container {
			display: flex;
		}
		
        #pdb-topology-viewer {
            position: relative;
            width: calc(400px*1.28);
            height: 400px;
			margin-left: 50px;
        }
		
		#myViewer{
			height: 400px;
			margin-left: 50px;
			width: 500px;
			position: relative;
		}
		
		#overprot-wrapper {
			width: 1000px;
			height: 200px;
		}
    </style>

  </head>

  <body>
  <main>
	<div class="container-fluid">
		<h4>Demo (1D, 2D, and 3D)</h4>
		<form id="familyAndDomainForm">
			<div class="form-row">
				<label for="familiesSelector" class="col-sm-2 col-form-label col-form-label-sm">Protein family (CATH):</label>
				<div class="col">
					<select id="familiesSelector" class="selectpicker form-control form-control-sm show-tick" data-live-search="true" data-size="5" data-hide-disabled="false" data-container="body" onchange=""></select>
				</div>
				<label for="domainsSelector" class="col-sm-2 col-form-label col-form-label-sm">Protein domain:</label>
				<div class="col">
					<select id="domainsSelector" class="selectpicker form-control form-control-sm show-tick" data-live-search="true" data-size="5" data-hide-disabled="false" data-container "body" onchange=""></select>
				</div>
				<div class="col-2">
					<button type="submit" id="submitFamilyAndDomainForm" class="btn btn-primary">Submit</button>
				</div>
			</div>
		</form>
		
		<div id="overprot-wrapper">
		
		</div>
		
		<!-- PDB Topology Viewer container -->
		<div class="flex-container">
			<div id="pdb-topology-viewer"></div>
			<div id="myViewer"></div>
		</div>
	</div>
  </main>
    
	
	
	
	<!-- Fetching data for options in selectors -->
	<script>
	// (async () => {
		class IntegratedViewer {
			constructor() {
				// this.plugins = {
					// 'twoD': {
						// 'instance': new PdbTopologyViewerPlugin(),
					// },
					// 'threeD': {
						// 'instance': new PDBeMolstarPlugin(),
					// },
				// };
				this.wellcomePage = true;
				this.currentUrl = window.location.href;
				this.familyId;
				this.domainId;
				this.pdbId;
				this.structAsymId;
				this.authAsymId;
				// TODO: determine!
				this.entityId = '1';
				
				
			}
			
			parseUrl() {
				const url = new URL(this.currentUrl);
				this.familyId = url.searchParams.get('family_id');
				this.domainId = url.searchParams.get('domain_id');
				if (this.familyId && this.domainId) {
					this.wellcomePage = false;
				}
			}
			
			async setData() {
				const json = await getDomainData(this.familyId);
				console.log(json)
				const currentDomainData = json.filter(d => d.domain === this.domainId)[0];
				this.pdbId = currentDomainData['pdb'];
				this.structAsymId = currentDomainData['chain_id'];
				this.authAsymId = currentDomainData['auth_chain_id'];
			}
			
			render3D() {
				//Create plugin instance
				const viewerInstance = new PDBeMolstarPlugin();

				//Set options (Check out available options list in the documentation)
				var options = {
					moleculeId: this.pdbId,
					hideControls: true
				}

				//Get element from HTML/Template to place the viewer 
				var viewerContainer = document.getElementById('myViewer');

				//Call render method to display the 3D view
				viewerInstance.render(viewerContainer, options);
				
				<!-- TODO: fix, struct_asym_id is not always A -->
				const targetChainSelection = [{
					struct_asym_id: this.structAsymId, 
					color:{r:255,g:255,b:255},
					focus: true,
				}];
				
				viewerInstance.events.loadComplete.subscribe(() => {
					viewerInstance.visual.select({ data: targetChainSelection, nonSelectedColor: {r:64,g:64,b:64}});
				});
				
				// Upon user hover on Topology Component residue, highlight that residue in MolStar view
				document.addEventListener('PDB.topologyViewer.mouseover', (event) => {
					viewerInstance.visual.highlight({ data: [{
						// entity_id: event.eventData['entityId'],
						struct_asym_id: event.eventData['chainId'],
						residue_number: event.eventData['residueNumber'],
					}], color: {r:255,g:0,b:0},});
				});
				
				document.addEventListener('PDB.topologyViewer.mouseout', (event) => {
					viewerInstance.visual.clearHighlight();
				});
				
				<!-- TODO: add visual highlight based on d and this -->
				
				document.addEventListener('PDB.topologyComponent.click', (event) => {
				});
				
				<!-- document.addEventListener('PDB.overprot.select', (event) => { -->
					<!-- console.log('PDB.overprot.select', event); -->
					<!-- for (const viewer of document.querySelectorAll('overprot-viewer')) { -->
						<!-- viewer.dispatchEvent(new CustomEvent('PDB.overprot.do.select', {detail: event.detail})); -->
					<!-- } -->
				<!-- }); -->
				
				<!-- H5 helix is not present in 2D, so it is not highlighted -->
				document.addEventListener('PDB.overprot.hover', (event) => {
					if (event.detail.sses[0]) {
						console.log('PDB.overprot.hover', event);
						<!-- TODO: fix console error - offhover overprot shoots another event with .sses = empty array -->
						const sses = event.detail.sses;
						
						let molstarData = sses.map(sse => {
							<!-- Right now sseLabel selects 4 topo elements (two in mask, one outside of mask (default one), one which is raised above connecting coils). Fixed by adding class to the last one -->
							const data = d3.select(`#${sse.label}.topologyEleTopLayer`)
							.attr('fill', 'rgb(211,211,211)')
							.attr('fill-opacity','1.0')
							.data()
							<!-- TODO: add Mol* selection thing -->
							<!-- data[0] contains data bound to topologyEle, including residues -->
							console.log(data[0]);
							<!-- Checking if this SSE exists in 2D view -->
							if (data[0]) {
								const molstarSelectionData = {
								entity_id: data[0].proteinData.entityId,
								struct_asym_id: data[0].proteinData.chainId,
								start_residue_number: data[0].start,
								end_residue_number: data[0].stop,
								};
								return molstarSelectionData;
							} else {
								console.log(`${sse.label} secondary structure element is not present in selected domain, only in some other proteins of that family.`)
								return {}
							}					
						});
						
						molstarData = molstarData.filter(d => Object.keys(d).length !== 0);
						console.log(molstarData);
						
						viewerInstance.visual.highlight({ data: molstarData, color: {r:255,g:0,b:0},});
						
					} else {
						<!-- empty detail.label arr => event was fired onmouseover/offhover -->
						d3.selectAll('.topologyEle.topologyEleTopLayer')
						.attr('fill', 'none')
						.attr('fill-opacity', null)
						
						viewerInstance.visual.clearHighlight();
					}
				});
			}
				
			render2D() {
				// document.addEventListener('DOMContentLoaded', () => {
					//Create plugin instance
					const pluginInstance = new PdbTopologyViewerPlugin();

					//Get element from HTML/Template to place the view
					const viewContainer = document.getElementById('pdb-topology-viewer');
					console.log(this.pdbId, this.entityId, this.structAsymId, this.familyId, this.domainId)
					const options = {
					  entryId: this.pdbId,
					  entityId: this.entityId,
					  chainId: this.structAsymId,
					  familyId:	this.familyId,
					  domainId: this.domainId,
					  // entryId: '1akd',
					  // entityId: '1',
					  // chainId: 'A',
					  // entryId: '3oh1',
					  // entityId: '1',
					  // chainId: 'A',
					} 
				
					//Call render method to display the 2D view
					pluginInstance.render(viewContainer, options);
					
					<!-- 2D => 1D hover event listener -->
					document.addEventListener('PDB.topologyViewer.mouseover', (event) => {
						<!-- console.log(event) -->
						document.querySelector('overprot-viewer').dispatchEvent(new CustomEvent('PDB.overprot.do.hover', {
							detail: {
										'sses': [{'label': event.eventData.parentSSEId}]
									}
								}));
					});
					
					document.addEventListener('PDB.topologyViewer.mouseout', (event) => {
						<!-- console.log(event) -->
						document.querySelector('overprot-viewer').dispatchEvent(new CustomEvent('PDB.overprot.do.hover', {
							detail: {
										'sses': []
									}
								}));
					});
				// });
			}
			
			render1D() {
				<!-- Actually insert in HTML rather than render -->
				const html = `<overprot-viewer id='anything' file='https://overprot.ncbr.muni.cz/data/db/diagrams/diagram-${this.familyId}.json' width=1800 height=300 color-method='type' shape-method='symcdf' beta-connectivity='on' occurrence-threshold='25%' dispatch-events='true' listen-events='true'></overprot-viewer>`;
				
				const container = document.getElementById('overprot-wrapper');
				container.innerHTML = html;
			}
			
			
		}
		
		const instance = new IntegratedViewer();
		instance.parseUrl();
		
		if (!instance.wellcomePage) {
			document.addEventListener('DOMContentLoaded', () => {
				console.log('dom loaded')
				instance.setData()
				.then(() => {
					instance.render1D();
					instance.render2D();
					instance.render3D();	
				});
			});
		}		
		// TODO: add some content specific to wellcome page
		
		function loadFamiliesFile() {
			const path = "https://overprot.ncbr.muni.cz/data/db/families.txt";
			let content = "";
			let request = new XMLHttpRequest();
			request.onreadystatechange = function() {
				if (request.readyState == 4 && request.status == 200) {
					content = String(request.responseText);
				}
			}
			request.open("GET", path, false);
			request.overrideMimeType("text/html");
			request.send();
			
			const arr = content.replace(/\r/g, "").split(/\n/);
			return arr;
		}
		
		function generateDatalist(arr, datalistEle) {
			datalistEle.innerHTML = '';
			for (let i in arr) {
				datalistEle.appendChild(new Option(arr[i], arr[i]));
			}
		}
		
		async function getDomainData(familyId) {
				// TODO: error handling (e.g. non-existing familyId)
				//CATH family ID, e.g. 1.10.630.10
				const url = `https://overprot.ncbr.muni.cz/data/db/families/${familyId}/domains.json`;
				const response = await fetch(url);
				const json = await response.json();
				console.log(json);
				return json;
		}
		
		async function getDomainsOptions(familyId) {
			const json = await getDomainData(familyId);		
			const arr = json.map(domain => domain.domain);
			<!-- console.log(arr); -->
			const datalistEle = document.getElementById('domainsDatalist');
			
			generateDatalist(arr, datalistEle);
			return json;
		}
		
		generateDatalist(loadFamiliesFile(), document.getElementById("familiesDatalist"));
		
		const familiesSelector = document.getElementById('familiesSelector');
		const domainsSelector = document.getElementById('domainsSelector');
		familiesSelector.addEventListener('change', function(event) {
			console.log(event.target.value);
			domainsSelector.value = '';
			getDomainsOptions(event.target.value);
		});
		
		<!-- Mol* and OverProt part -->
		
		
		
		<!-- Topology Viewer (2D) part -->
		document.addEventListener('DOMContentLoaded', () => {


		  });
	// })();
	</script>
	<!-- Mol* & OverProt script (e.g. events) -->
	<script>
	
	</script>
	<!-- PDB Topology component script -->
    <script>
      
    </script>
	
	<!-- PDB Mol* component script -->
	<script>
      
	  
    </script>
  </body>

</html>